<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>耗材申购系统 - 管理员后台</title>
    <!-- 引入样式、图标和Excel导出库 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        .card-shadow { box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .fade-in { animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- 管理员登录 -->
    <div id="admin-login-page" class="flex items-center justify-center min-h-screen px-4">
        <div class="w-full max-w-md bg-white rounded-lg p-8 card-shadow fade-in">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">管理员后台</h2>
            <div id="admin-login-error" class="hidden text-red-500 text-center mb-4"></div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">管理员账号</label>
                    <input type="text" id="admin-username" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="请输入管理员账号">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">密码</label>
                    <input type="password" id="admin-password" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="请输入密码">
                </div>
                <button id="admin-login-btn" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 transition-colors">
                    登录
                </button>
                <div class="flex justify-between items-center">
                    <a href="index.html" class="text-sm text-blue-600 hover:text-blue-800">返回用户端</a>
                </div>
            </div>
            <div class="mt-4 text-center text-sm text-gray-500">
                管理员账号：admin / 密码：admin123
            </div>
        </div>
    </div>

    <!-- 后台主页面 -->
    <div id="admin-main-page" class="hidden fade-in">
        <!-- 顶部导航 -->
        <nav class="bg-white shadow-sm px-6 py-4 sticky top-0 z-10">
            <div class="flex justify-between items-center">
                <h1 class="text-xl font-bold text-gray-800">耗材申购系统 - 管理员后台</h1>
                <div class="flex items-center gap-4">
                    <span class="text-gray-700">管理员</span>
                    <button id="admin-logout-btn" class="text-red-600 hover:text-red-700 transition-colors">
                        <i class="fas fa-sign-out-alt mr-1"></i>退出登录
                    </button>
                </div>
            </div>
        </nav>

        <!-- 主内容区 -->
        <div class="container mx-auto px-4 py-6">
            <!-- 筛选和导出栏 -->
            <div class="bg-white p-4 rounded-lg card-shadow mb-6">
                <div class="flex flex-col md:flex-row md:items-center gap-4 justify-between">
                    <div class="flex flex-col sm:flex-row gap-4">
                        <div class="w-full sm:w-48">
                            <label class="block text-sm font-medium text-gray-700 mb-1">按用户筛选</label>
                            <input type="text" id="filter-username" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="输入用户名">
                        </div>
                        <div class="w-full sm:w-48">
                            <label class="block text-sm font-medium text-gray-700 mb-1">按日期筛选</label>
                            <input type="date" id="filter-date" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    <div class="flex gap-4">
                        <button id="refresh-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition-colors">
                            <i class="fas fa-refresh mr-1"></i>刷新数据
                        </button>
                        <button id="export-btn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">
                            <i class="fas fa-file-excel mr-1"></i>导出Excel
                        </button>
                    </div>
                </div>
            </div>

            <!-- 申购记录统计 -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="bg-white p-4 rounded-lg card-shadow">
                    <h3 class="text-sm font-medium text-gray-500 mb-1">总申购单数量</h3>
                    <p id="total-records" class="text-2xl font-bold text-gray-800">0</p>
                </div>
                <div class="bg-white p-4 rounded-lg card-shadow">
                    <h3 class="text-sm font-medium text-gray-500 mb-1">申购用户数</h3>
                    <p id="total-users" class="text-2xl font-bold text-gray-800">0</p>
                </div>
                <div class="bg-white p-4 rounded-lg card-shadow">
                    <h3 class="text-sm font-medium text-gray-500 mb-1">总耗材申购种类</h3>
                    <p id="total-supply-types" class="text-2xl font-bold text-gray-800">0</p>
                </div>
            </div>

            <!-- 申购记录列表 -->
            <div class="bg-white rounded-lg card-shadow mb-6">
                <div class="p-4 border-b border-gray-200">
                    <h2 class="text-lg font-semibold text-gray-800">申购记录列表</h2>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">序号</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">申购用户</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">申购时间</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">耗材种类数</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                            </tr>
                        </thead>
                        <tbody id="records-list" class="divide-y divide-gray-200">
                            <!-- 记录列表由JS动态生成 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 详情弹窗 -->
    <div id="detail-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-2xl w-full max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">申购详情</h3>
                <button id="close-detail-modal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="detail-content" class="space-y-4">
                <!-- 详情内容由JS动态生成 -->
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let allRecords = [];

        // 页面初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 绑定事件
            document.getElementById('admin-login-btn').addEventListener('click', adminLogin);
            document.getElementById('admin-logout-btn').addEventListener('click', adminLogout);
            document.getElementById('refresh-btn').addEventListener('click', loadRecords);
            document.getElementById('export-btn').addEventListener('click', exportToExcel);
            document.getElementById('close-detail-modal').addEventListener('click', closeDetailModal);
            document.getElementById('filter-username').addEventListener('input', filterRecords);
            document.getElementById('filter-date').addEventListener('change', filterRecords);
        });

        // ========== 管理员登录 ==========
        function adminLogin() {
            const username = document.getElementById('admin-username').value.trim();
            const password = document.getElementById('admin-password').value.trim();
            const errorEl = document.getElementById('admin-login-error');
            
            if (!username || !password) {
                errorEl.textContent = "账号和密码不能为空";
                errorEl.classList.remove('hidden');
                return;
            }
            
            // 管理员验证
            if (username === "admin" && password === "admin123") {
                document.getElementById('admin-login-page').classList.add('hidden');
                document.getElementById('admin-main-page').classList.remove('hidden');
                errorEl.classList.add('hidden');
                // 加载申购记录
                loadRecords();
            } else {
                errorEl.textContent = "管理员账号或密码错误";
                errorEl.classList.remove('hidden');
            }
        }

        function adminLogout() {
            document.getElementById('admin-main-page').classList.add('hidden');
            document.getElementById('admin-login-page').classList.remove('hidden');
            document.getElementById('admin-username').value = "";
            document.getElementById('admin-password').value = "";
        }

        // ========== 记录加载和筛选 ==========
        function loadRecords() {
            // 从本地存储获取所有申购记录
            allRecords = JSON.parse(localStorage.getItem('applyRecords') || '[]');
            // 渲染记录列表
            renderRecords(allRecords);
            // 更新统计数据
            updateStatistics(allRecords);
        }

        function filterRecords() {
            const usernameFilter = document.getElementById('filter-username').value.toLowerCase().trim();
            const dateFilter = document.getElementById('filter-date').value;
            
            let filteredRecords = [...allRecords];
            
            // 按用户名筛选
            if (usernameFilter) {
                filteredRecords = filteredRecords.filter(record => 
                    record.username.toLowerCase().includes(usernameFilter)
                );
            }
            
            // 按日期筛选
            if (dateFilter) {
                filteredRecords = filteredRecords.filter(record => {
                    const recordDate = new Date(record.applyTime).toISOString().split('T')[0];
                    return recordDate === dateFilter;
                });
            }
            
            renderRecords(filteredRecords);
            updateStatistics(filteredRecords);
        }

        function renderRecords(records) {
            const listEl = document.getElementById('records-list');
            listEl.innerHTML = "";
            
            if (records.length === 0) {
                listEl.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-12 text-center text-gray-500">
                            暂无申购记录
                        </td>
                    </tr>
                `;
                return;
            }
            
            records.forEach((record, index) => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50";
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${index + 1}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${record.username}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${record.applyTime}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${record.items.length}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <button onclick="viewDetail(${index})" class="text-blue-600 hover:text-blue-800">
                            <i class="fas fa-eye mr-1"></i>查看详情
                        </button>
                    </td>
                `;
                listEl.appendChild(tr);
            });
        }

        // ========== 统计和详情 ==========
        function updateStatistics(records) {
            // 总申购单数量
            document.getElementById('total-records').textContent = records.length;
            
            // 申购用户数（去重）
            const users = [...new Set(records.map(record => record.username))];
            document.getElementById('total-users').textContent = users.length;
            
            // 总耗材申购种类（去重）
            const supplyTypes = new Set();
            records.forEach(record => {
                record.items.forEach(item => {
                    supplyTypes.add(`${item.category}-${item.name}-${item.spec}`);
                });
            });
            document.getElementById('total-supply-types').textContent = supplyTypes.size;
        }

        function viewDetail(index) {
            const record = allRecords[index];
            const detailEl = document.getElementById('detail-content');
            
            // 拼接详情HTML
            let html = `
                <div class="border-b pb-2">
                    <p class="text-sm text-gray-500">申购用户：<span class="text-gray-800 font-medium">${record.username}</span></p>
                    <p class="text-sm text-gray-500">申购时间：<span class="text-gray-800 font-medium">${record.applyTime}</span></p>
                </div>
                <div>
                    <h4 class="font-medium text-gray-800 mb-2">申购耗材明细：</h4>
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">分类</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">耗材名称</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">规格</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">数量</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
            `;
            
            // 遍历该用户的申购耗材
            record.items.forEach(item => {
                html += `
                    <tr>
                        <td class="px-3 py-2 text-sm text-gray-700">${item.category}</td>
                        <td class="px-3 py-2 text-sm text-gray-700">${item.name}</td>
                        <td class="px-3 py-2 text-sm text-gray-700">${item.spec}</td>
                        <td class="px-3 py-2 text-sm text-gray-700">${item.quantity}</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            detailEl.innerHTML = html;
            document.getElementById('detail-modal').classList.remove('hidden');
        }

        function closeDetailModal() {
            document.getElementById('detail-modal').classList.add('hidden');
        }

        // ========== 导出Excel ==========
        function exportToExcel() {
            if (allRecords.length === 0) {
                alert('暂无记录可导出');
                return;
            }
            
            // 整理导出数据（扁平化）
            const exportData = [];
            exportData.push(['申购用户', '申购时间', '耗材分类', '耗材名称', '规格', '数量']);
            
            allRecords.forEach(record => {
                record.items.forEach(item => {
                    exportData.push([
                        record.username,
                        record.applyTime,
                        item.category,
                        item.name,
                        item.spec,
                        item.quantity
                    ]);
                });
            });
            
            // 创建Excel工作簿并导出
            const ws = XLSX.utils.aoa_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "申购记录");
            XLSX.writeFile(wb, `耗材申购记录_${new Date().toLocaleDateString().replace(/\//g, '-')}.xlsx`);
        }
    </script>
</body>
</html>